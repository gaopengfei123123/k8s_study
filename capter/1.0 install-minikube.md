#### mac æœ¬åœ°å®‰è£…minikubeç¯å¢ƒ

ç¯å¢ƒéœ€æ±‚:
* kubectl       æœ¬åœ°åšå‘½ä»¤è¡Œæ§åˆ¶ç”¨, æ‰€æœ‰çš„å‘½ä»¤æ“ä½œéƒ½æ˜¯é€šè¿‡å®ƒ
* vittualBox    v5.1 +  æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬å°±å¯¹äº†
* minikube      åœ¨æœ¬åœ°æ­å»ºæµ‹è¯•ç¯å¢ƒ

ç¿»å¢™æœ‰å›°éš¾çš„å¯ä»¥å‚è€ƒä¸€ä¸‹è¿™ä¸ª https://yq.aliyun.com/articles/221687

å®‰è£… `kubectl`
```s
âœ   brew install kubectl
```

ä¸‹è½½æœ€æ–° `minikube` ä¸å»ºè®®ä½¿ç”¨brewå®‰è£…,  é¦–å…ˆç‰ˆæœ¬ä¸ä¼šæ˜¯æœ€æ–°, å†è€…ä¼šå‡ºç°è«åå…¶å¦™çš„é—®é¢˜
```s
âœ   curl -Lo minikube https://storage.googleapis.com/minikube/releases/latest/minikube-darwin-amd64 && \
  chmod +x minikube && \
  sudo mv minikube /usr/local/bin/
```

é»˜è®¤ start æ—¶è¿è¡Œçš„virtualBox å»å®˜ç½‘ä¸‹ä¸ªæœ€æ–°çš„å°±è¡Œ

å¯åŠ¨, æœ€å¥½æŠŠdockeré•œåƒæŒ‡å®šåˆ°å›½å†…
```s
âœ  ~ minikube start --registry-mirror=https://registry.docker-cn.com
ğŸ˜„  minikube v1.0.1 on darwin (amd64)
ğŸ’¿  Downloading Minikube ISO ...
 142.88 MB / 142.88 MB [============================================] 100.00% 0s
ğŸ¤¹  Downloading Kubernetes v1.14.1 images in the background ...
ğŸ”¥  Creating virtualbox VM (CPUs=2, Memory=2048MB, Disk=20000MB) ...
ğŸ“¶  "minikube" IP address is 192.168.99.103
ğŸ³  Configuring Docker as the container runtime ...
ğŸ³  Version of container runtime is 18.06.3-ce
âŒ›  Waiting for image downloads to complete ...
âœ¨  Preparing Kubernetes environment ...
ğŸ’¾  Downloading kubeadm v1.14.1
ğŸ’¾  Downloading kubelet v1.14.1
ğŸšœ  Pulling images required by Kubernetes v1.14.1 ...
ğŸš€  Launching Kubernetes v1.14.1 using kubeadm ...
âŒ›  Waiting for pods: apiserver proxy etcd scheduler controller dns
ğŸ”‘  Configuring cluster permissions ...
ğŸ¤”  Verifying component health .....
ğŸ’—  kubectl is now configured to use "minikube"
ğŸ„  Done! Thank you for using minikube!
âœ  ~ kubectl cluster-info
Kubernetes master is running at https://192.168.99.103:8443
KubeDNS is running at https://192.168.99.103:8443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy

To further debug and diagnose cluster problems, use 'kubectl cluster-info dump'.
```

å¦‚æœ`Minikube ISO`å­˜åœ¨å¢™çš„é—®é¢˜, å°±æŠŠisoä¸‹è½½åæ”¾åˆ° `~/.minikube/cache/iso/`ä¸‹

è¿™æ—¶Macä¸Šçš„dockerä¸èƒ½ç”¨docker for Macæä¾›çš„äº†, è€Œæ˜¯å®¿ä¸»æœºé‡Œé¢çš„docker, åˆ‡æ¢å‘½ä»¤ä¸º:
```s
âœ   evalÂ $(minikube docker-env)
```

æ’¤é”€æ›´æ”¹
```s
âœ   eval $(minikube docker-env -u)
```

åŠ è½½åå°æ§åˆ¶é¢æ¿, ç¨ç­‰ä¸€ä¼š, è‡ªåŠ¨æ‰“å¡åå°ç•Œé¢
```s
âœ   minikube dashboard
```

#### éƒ¨ç½²ç¬¬ä¸€ä¸ªåº”ç”¨

##### å‘½ä»¤è¡Œéƒ¨ç½²

###### åˆ›å»ºnode.js åº”ç”¨

åˆ›å»ºæ–‡ä»¶ `server.js`
```js
var http = require('http');

var handleRequest = function(request, response) {
  console.log('Received request for URL: ' + request.url);
  response.writeHead(200);
  response.end('Hello World! V1');
};
var www = http.createServer(handleRequest);
www.listen(3000);
```
è¿è¡Œ
```s
node server.js   // è®¿é—®åœ°å€  http://localhost:3000
```

###### åˆ›å»ºdockeré•œåƒ
```dockerfile
FROM node:8.10.0

EXPOSE 3000

COPY server.js .
CMD ["node", "server.js"]
```
æ„å»ºé•œåƒ
```s
âœ docker build -t hello-node:v1 .
```
å¦‚æœå‡ºç°`Cannot connect to the Docker daemon at unix:///var/run/docker.sock. Is the docker daemon running?` è¯´æ˜ä½ å¿˜äº†æ‰§è¡Œ `evalÂ $(minikube docker-env)`
**kubeç”¨çš„ docker å’Œä½ æœ¬åœ°ç”¨çš„ docker æ˜¯ä¸¤ä¸ªä½ç½®, kubeçš„åœ¨è™šæ‹Ÿæœºé‡Œè¿è¡Œ**

###### åˆ›å»º deployment
æœ‰äº†é•œåƒå°±å…·å¤‡åˆ›å»ºpodçš„æ¡ä»¶, é€šå¸¸æ¥è¯´ä¸ç”¨ç›´æ¥åˆ›å»º `pod`, è€Œæ˜¯åˆ›å»º `deployment` æˆ–è€… `replication controller`, ç”±ä»–ä»¬æ¥è´Ÿè´£ç®¡ç†æœåŠ¡çš„è¿è¡Œ, è§„æ¨¡ç¼©æ”¾, è‡ªåŠ¨é‡å¯ç­‰ç­‰è¿™äº›æ“ä½œ, å°±å•ä¸ª`pod`æ¥è¯´æ˜¯å¯ä»¥éšæ—¶è¢«é”€æ¯çš„, ä¸èƒ½ä½œä¸ºç¨³å®šæœåŠ¡çš„ä¿è¯

```s
âœ kubectl run hello-node --image=hello-node:v1 --port=3000
æˆ–
âœ kubectl create deployment hello-node --image=hello-node:v1
```
æŸ¥çœ‹å½“å‰`deployment`
```s
âœ kubectl get deployments 
NAME           READY   UP-TO-DATE   AVAILABLE   AGE
hello-node     1/1     1            1           8m8s
```
`ready 1/1` è¯´æ˜å·²ç»å‡†å¤‡å°±ç»ªäº† 

æŸ¥çœ‹ `pod`
```s
âœ  hellonode git:(master) âœ— kubectl get pods
NAME                            READY   STATUS    RESTARTS   AGE
hello-node-5c58cb6dd4-h65fx     1/1     Running   0          8m40s
```
ä»è¿™ä¸¤æ¡ä¿¡æ¯å°±èƒ½çœ‹å‡ºæ¥, æ¯ä¸ªpodéƒ½æ˜¯å¸¦éšæœºå­—ç¬¦ä¸²çš„, å¹¶ä¸æ‰“ç®—ç»™äººå»æ“ä½œ, æˆ‘ä»¬ä¸»è¦ä¸“æ³¨åœ¨`deployment`å’Œ `service` çš„æ­å»º

æŸ¥çœ‹ `deployment` æè¿°
```
âœ kubectl describe deployments/hello-node

Name:                   hello-node
Namespace:              default
CreationTimestamp:      Mon, 13 May 2019 14:17:03 +0800
Labels:                 run=hello-node
Annotations:            deployment.kubernetes.io/revision: 1
Selector:               run=hello-node
Replicas:               1 desired | 1 updated | 1 total | 1 available | 0 unavailable
StrategyType:           RollingUpdate
MinReadySeconds:        0
RollingUpdateStrategy:  25% max unavailable, 25% max surge
Pod Template:
  Labels:  run=hello-node
  Containers:
   hello-node:
    Image:        hello-node:v1
    Port:         3000/TCP
    Host Port:    0/TCP
    Environment:  <none>
    Mounts:       <none>
  Volumes:        <none>
Conditions:
  Type           Status  Reason
  ----           ------  ------
  Available      True    MinimumReplicasAvailable
  Progressing    True    NewReplicaSetAvailable
OldReplicaSets:  <none>
NewReplicaSet:   hello-node-5c58cb6dd4 (1/1 replicas created)
Events:
  Type    Reason             Age   From                   Message
  ----    ------             ----  ----                   -------
  Normal  ScalingReplicaSet  11m   deployment-controller  Scaled up replica set hello-node-5c58cb6dd4 to 1
```
è¿™é‡Œæ˜¯å¯¹`deployment`çš„æ¦‚è§ˆ, `Pod Template:` ä¸‹å°±æ˜¯æ¯ä¸ªpodsçš„é…ç½®, ä¹‹åå¯¹éƒ¨ç½²çš„æ‰©å®¹éƒ½æ˜¯åŸºäºè¿™ä¸ªå»å¤åˆ¶

åˆ°ç›®å‰ä¸ºæ­¢æˆ‘ä»¬åˆ›å»ºäº†`deployment` è€Œä¸”ä¹Ÿè‡ªåŠ¨ç”Ÿæˆ`pod`äº†, å¯æ˜¯æœåŠ¡å¹¶ä¸èƒ½è¢«è®¿é—®åˆ°, ä¸ºä»€ä¹ˆ? å› ä¸ºç«¯å£æ²¡æœ‰å¯¹å¤–æš´éœ²å‡ºæ¥, æ‰€ä»¥æœ‰äº†ä¸‹ä¸€æ­¥


###### åˆ›å»ºservice
`service` å°±æ˜¯ç”¨æ¥å¯¹æˆ‘æš´éœ²æœåŠ¡çš„ä¸œè¥¿, æ‰€æœ‰çš„ `pod` éƒ½æ˜¯åœ¨å†…ç½‘é€šä¿¡, å¤–éƒ¨è®¿é—®å°±å¾—è®© `service` è¿™å±‚ä»£ç†å»è½¬å‘è¿‡å», `--type=LoadBalancer` å°±æ˜¯æŒ‡å®šè½¬å‘ä¸ºè´Ÿè½½å‡è¡¡æ¨¡å¼, `kubectl create service -h` æŸ¥çœ‹æ›´å¤š, è¿™é‡Œä¸ç»†è®²

åˆ›å»ºservice
```s
âœ kubectl expose deployment hello-node --type=LoadBalancer
æˆ–
âœ kubectl expose deployment hello-node --type=LoadBalancer --port=3000 // è¿™é‡ŒæŒ‡å®šç«¯å£
```
æŸ¥çœ‹
```s
âœ kubectl get service                                     
NAME         TYPE           CLUSTER-IP      EXTERNAL-IP   PORT(S)          AGE
hello-node   LoadBalancer   10.111.18.151   <pending>     3000:31349/TCP   3s
kubernetes   ClusterIP      10.96.0.1       <none>        443/TCP          3d
```
è¯¦ç»†ä¿¡æ¯
```s
âœ kubectl describe services hello-node 
Name:                     hello-node
Namespace:                default
Labels:                   run=hello-node
Annotations:              <none>
Selector:                 run=hello-node
Type:                     LoadBalancer
IP:                       10.111.18.151
Port:                     <unset>  3000/TCP
TargetPort:               3000/TCP
NodePort:                 <unset>  31349/TCP
Endpoints:                172.17.0.7:3000
Session Affinity:         None
External Traffic Policy:  Cluster
Events:                   <none>
```
`NodePort` å°±æ˜¯ç»‘å®šåœ¨èŠ‚ç‚¹çš„é‚£ä¸ªç«¯å£ä¸Š, ç›´æ¥è®¿é—®èŠ‚ç‚¹ipå°±è¡Œ, ä¹Ÿå¯ä»¥ç”¨minikubeå‘½ä»¤ `minikube service hello-node` è‡ªåŠ¨å¸®ä½ æ‰“å¼€æœ¬åœ°åœ°å€


###### æ‰©å±•ç¤ºä¾‹
çº¿ä¸Šè‚¯å®šæ˜¯æœ‰è¿™ç§åŠ¨æ€æ‰©å®¹çš„æƒ…å†µ, è€Œä¸”å¤šå®ä¾‹ä¹‹é—´æ»šåŠ¨å‡çº§ä¹Ÿä¸ä¼šåœæ­¢æœåŠ¡
```s
âœ kubectl scale deployments/hello-node --replicas=4
deployment.extensions/hello-node scaled
âœ  hellonode git:(master) âœ— kubectl get pods
NAME                          READY   STATUS    RESTARTS   AGE
hello-node-5c58cb6dd4-d2qq9   1/1     Running   0          18s
hello-node-5c58cb6dd4-h65fx   1/1     Running   0          51m
hello-node-5c58cb6dd4-jlzjw   1/1     Running   0          18s
hello-node-5c58cb6dd4-vmx4f   1/1     Running   0          18s
```

###### æ›´æ–°åº”ç”¨
é‡æ–°æ„å»ºä¸€ä¸ªnodeçš„é•œåƒ
service.js
```js
var http = require('http');

var handleRequest = function(request, response) {
  console.log('Received request for URL: ' + request.url);
  response.writeHead(200);
  response.end('Hello World! V2');
};
var www = http.createServer(handleRequest);
www.listen(3000);
```

```s
âœ docker build -t hello-node:v2 .
```
è®¾ç½® `deployment` ä½¿ç”¨æ–°é•œåƒ
```s
âœ kubectl set image deployment/hello-node hello-node=hello-node:v2
```
æŸ¥çœ‹æ¯ä¸ªpodçš„å…·ä½“æƒ…å†µ
```s 
âœ kubectl describe pods
```
å†è®¿é—®åˆšæ‰çš„åœ°å€å°±èƒ½çœ‹åˆ°æ”¹å˜äº†

###### æ¸…é™¤èµ„æº
```s
âœ kubectl delete service hello-node
âœ kubectl delete deployments hello-node
```

ç»è¿‡ä¸Šé¢ä¸€å¥—æ“ä½œä¸‹æ¥, åº”è¯¥ä¹Ÿå¯¹k8sæœ‰äº†ä¸€ä¸ªå¤§è‡´çš„å°è±¡äº†, æ¯•ç«Ÿå…‰çœ‹å®è·µæ‰æ˜¯æ£€éªŒçœŸç†çš„å”¯ä¸€æ ‡å‡†, ä½†æ˜¯å¦‚æœéƒ¨ç½²ä¸€ä¸ªæœåŠ¡è¿™æ ·ä¸€ä¸ªå‘½ä»¤ä¸€ä¸ªå‘½ä»¤çš„æ•²æ˜¯å¾ˆè¦å‘½çš„, è€Œä¸”æœåŠ¡å™¨è¿™ç©æ„, è½»æ˜“ä¸ä¼šåŠ¨, æ—¶é—´ä¸€é•¿å°±å®¹æ˜“å¿˜, å› æ­¤ç”¨é…ç½®æ–‡ä»¶å»å¯åŠ¨æ›´åŠ åˆç†

##### é€šè¿‡ yaml å¯åŠ¨
å¦‚ä¸‹: test-service.yaml
```yaml
apiVersion: v1
kind: Service
metadata: 
  name: test-service
  labels:
    version: v2
    run: hello-node
    app: test-service
spec:
  type: LoadBalancer
  ports:
  - port: 3001
    targetPort: 3000
    protocol: TCP
  selector:
    app: test-service
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: test-service
  labels:
    app: test-service
spec:
  replicas: 2
  selector:
    matchLabels:
      app: test-service
  template:
    metadata:
      labels:
        app: test-service
    spec:
      containers:
      - name: node-pod
        image: hello-node:v2
        imagePullPolicy: IfNotPresent
        ports: 
        - containerPort: 3000
```
æ‰§è¡Œ
```s
âœ kubectl create -f test-service.yaml
âœ minikube service test-service
```
è¿™æ ·é€šè¿‡é…ç½®æ–‡ä»¶å°±èƒ½å¯åŠ¨äº†, é…ç½®æ–‡ä»¶é‡Œé‡Œçš„å­—æ®µåç»­æˆ‘ä»¬å†è¯¦ç»†çš„è®²ä¸€ä¸‹

åˆ é™¤` kubectl delete -f test-service.yaml`

[ä»£ç åœ°å€](https://github.com/gaopengfei123123/k8s_study/tree/master/demo/hellonode)

#### ç›¸å…³èµ„æ–™
* [å¸¦ä½ ç†è§£Kubernetesï¼Œéƒ¨ç½²ä¸€ä¸ªNodeåº”ç”¨](https://segmentfault.com/a/1190000014116698#articleHeader16)
* [Kubernetesçš„ä¸‰ç§å¤–éƒ¨è®¿é—®æ–¹å¼ï¼šNodePortã€LoadBalancer å’Œ Ingress](http://dockone.io/article/4884)
* [Minikube - Kubernetesæœ¬åœ°å®éªŒç¯å¢ƒ](https://yq.aliyun.com/articles/221687)
* [Kubernetesä¹‹kubectlå¸¸ç”¨å‘½ä»¤](https://blog.csdn.net/cc1949/article/details/78842291)
* [replication controllerä¸deploymentçš„åŒºåˆ«](https://www.cnblogs.com/boshen-hzb/p/7097811.html)
* [Kubenetesé‡Œpodå’Œserviceç»‘å®šçš„å®ç°æ–¹å¼](https://blog.csdn.net/weixin_33979203/article/details/89613400)
* [Kubernetesåˆ›å»ºèµ„æºå¯¹è±¡yamlæ–‡ä»¶ä¾‹å­](https://www.jianshu.com/p/bf3fb3a6e688)
* [kubernetes/minikube github](https://github.com/kubernetes/minikube)